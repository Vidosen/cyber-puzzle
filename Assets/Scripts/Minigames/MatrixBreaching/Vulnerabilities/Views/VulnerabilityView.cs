using System;
using Cysharp.Threading.Tasks;
using DG.Tweening;
using Minigames.MatrixBreaching.Config;
using Minigames.MatrixBreaching.Matrix.Data;
using Minigames.MatrixBreaching.Vulnerabilities.Models;
using UniRx;
using UnityEngine;
using UnityEngine.UI;
using Zenject;

namespace Minigames.MatrixBreaching.Vulnerabilities.Views
{
    public class VulnerabilityView : MonoBehaviour
    {
        public RectTransform Transform => _transform == null ? GetComponent<RectTransform>() : _transform;
        public VulnerabilityModel Model => _vulnerabilityModel;
        public bool IsInitialized => _vulnerabilityModel != null;

        [SerializeField] private Transform _cellViewsHolder;
        private VulnerabilityModel _vulnerabilityModel;
        private DiContainer _container;
        private MatrixBreachingViewConfig _viewConfig;

        private VulnerabilityCellView[] _vulnerabilityCellViews;
        private RectTransform _transform;

        private void Awake()
        {
            _transform = GetComponent<RectTransform>();
        }

        [Inject]
        private void Construct(DiContainer container, MatrixBreachingViewConfig viewConfig)
        {
            _viewConfig = viewConfig;
            _container = container;
        }
        public async void Initialize(VulnerabilityModel vulnerabilityModel)
        {
            _vulnerabilityModel = vulnerabilityModel;
            if (!_vulnerabilityModel.IsInitialized)
                await UniTask.WaitUntil(() => _vulnerabilityModel.IsInitialized);
            
            _vulnerabilityCellViews = new VulnerabilityCellView[_vulnerabilityModel.SequenceSize];
            for (int i = 0; i < _vulnerabilityModel.SequenceSize; i++)
            {
                _vulnerabilityCellViews[i] = InitCellView(_vulnerabilityModel.VulnerabilitySequence[i]);
            }

            _vulnerabilityModel.MatchedSequenceSize.Subscribe(matchedSize => UpdateCellsHighlight(matchedSize))
                .AddTo(this);
        }

        public async UniTask HideAnimation()
        {
            var endAnchorPos = _transform.anchoredPosition.x + _transform.sizeDelta.x * 1f;
            var animaition = _transform.DOAnchorPosX(endAnchorPos, 0.25f).SetEase(Ease.OutSine);
            await animaition.AsyncWaitForCompletion();
        }

        private void UpdateCellsHighlight(int matchedSize)
        {
            for (int i = 0; i < _vulnerabilityCellViews.Length; i++)
            {
                _vulnerabilityCellViews[i].SetHighlightActive( i < matchedSize);
            }
        }

        private VulnerabilityCellView InitCellView(CellValueType cellValue)
        {
            var cellView = _container.InstantiatePrefabForComponent<VulnerabilityCellView>(_viewConfig.VulnerabilityCellViewTemplate,
                _cellViewsHolder);
            cellView.Initialize(cellValue);
            return cellView;
        }
    }
}